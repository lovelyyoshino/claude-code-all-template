## 项目规划（PLANNING）

本文件定义本项目的总体架构、约束、流程与质量基线，供 AI 助手与开发者统一遵循。若无特别说明，默认语言为 Python，遵循 PEP8，使用 `black` 格式化，单元测试使用 Pytest。

### 1. 目标与范围
- **项目目标**：提供可扩展、可维护、可靠的代码基础设施与交互流程，支撑多特性演进。
- **不在范围**：与业务无关的试验性代码、超出既定技术栈的随意引入。

### 2. 硬性指标（Must-Follow）
#### 2.1 文件行数限制
- 动态语言（Python/JS/TS）：每个文件 ≤ 200 行
- 静态语言（Java/Go/Rust）：每个文件 ≤ 250 行
> 目的：提高可读性、可维护性，降低认知负担

#### 2.2 文件夹结构限制
- 每个文件夹中文件数量 ≤ 8 个
- 若超过，需进行多层子文件夹拆分
> 目的：提升结构清晰度，便于快速定位与扩展

### 3. 架构设计关注点（持续警惕）
必须时刻避免以下“坏味道”：
1) 僵化（Rigidity）：小改动引发连锁反应 → 引入接口抽象、策略模式、依赖倒置
2) 冗余（Redundancy）：重复逻辑 → 提取公用模块，组合优于继承
3) 循环依赖（Circular Dependency）：模块互锁 → 接口解耦、事件机制、依赖注入
4) 脆弱性（Fragility）：无关处出错 → 单一职责、高内聚
5) 晦涩性（Obscurity）：意图不明 → 清晰命名、适当注释、简洁结构、完善文档
6) 数据泥团（Data Clump）：参数成团 → 封装为对象/值对象
7) 不必要的复杂性（Needless Complexity）：过度设计 → YAGNI/KISS、按需设计

### 4. 代码结构与模块化
- 严格遵循模块边界，按功能/职责拆分。
- 约定（以代理为例）：
  - `agent.py`：主代理定义与运行逻辑
  - `tools.py`：工具函数
  - `prompts.py`：系统提示
- 使用相对导入（包内），使用 `python_dotenv` 并通过 `load_env()` 加载环境变量。

### 5. 测试策略
- 为新增功能编写 Pytest 单元测试：至少包含常规用例、边界用例、失败用例各 1 个。
- 测试位于 `/tests`，结构与主代码镜像。
- 更新逻辑后，检查并同步更新既有测试。

### 6. 文档与可理解性
- 功能、依赖或安装步骤变更时，更新 `README.md`。
- 为每个函数编写 Google 风格 docstring；对复杂逻辑添加 `# Reason:` 注释解释“为什么”。

### 7. 任务与流程
- 新对话开始先阅读本文件与 `CLAUDE.md`。
- 新任务前检查/更新 `TASK.md`（若不存在则创建），完成后立即标记完成并记录“工作中发现”。

### 8. 交互式占位符（需用户填写）
以下字段由用户在实施前确认，AI 可先给出合理默认并征求确认：
- <PROJECT_NAME>：项目名称（默认：MyProject）
- <PRIMARY_LANG>：主语言（默认：Python）
- <RUNTIME_STACK>：运行栈/框架（默认：FastAPI + SQLModel）
- <TEST_COVERAGE_TARGET>：最低测试覆盖率（默认：70%）
- <MODULE_BOUNDARIES>：核心模块边界说明
- <NON_FUNCTIONAL_REQS>：非功能性指标（性能/安全/可观测性等）

AI 交互流程建议：
1) 读取本文件与 `CLAUDE.md` → 生成占位符默认值
2) 将默认值一次性展示给用户 → 询问是否修改
3) 用户确认后固化为 `PLANNING.lock.json`（可选）

### 9. 质量门禁（Validation Gates）
- 通过 `pre-commit`/lint/format 检查
- 通过单元测试
- 文件/目录硬性指标合规（行数、数量）
- 无循环依赖（可借助静态分析）

### 10. 重要提醒
> 非常重要：编写、阅读或评审代码时，严格遵守硬性指标，并主动识别“坏味道”。
> 非常重要：一旦发现问题，立即提出优化建议并落实。


